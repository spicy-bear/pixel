<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixelator</title>
    <style>
        body {
            font-family: 'Google Sans', Arial, sans-serif;
            background: #181a1b;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        h1 {
            color: #e0e0e0;
            text-shadow: 0 1px 0 #111;
            margin-top: 32px;
            font-weight: 600;
            letter-spacing: -1px;
        }
        .container {
            max-width: 1100px;
            margin: 32px auto 0 auto;
            padding: 24px;
            background: #232526;
            border-radius: 18px;
            box-shadow: 0 4px 32px 0 rgba(0,0,0,.25);
        }
        .top-bar {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }
        .fab-label {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .fab-label span {
            font-size: 0.85rem;
            color: #888;
            margin-top: 4px;
        }
        .fab {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #333;
            color: #bbb;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 8px;
            transition: background 0.2s, color 0.2s, opacity 0.2s;
            font-size: 1.7rem;
            opacity: 1;
        }
        .fab:disabled {
            background: #222;
            color: #444;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .fab:hover:not(:disabled) {
            background: #444;
            color: #fff;
        }
        #upload {
            display: none;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 32px;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 24px;
            background: #181a1b;
            border-radius: 12px;
            padding: 18px 12px;
        }
        label {
            color: #bbb;
            font-size: 1rem;
            margin-bottom: 0.5em;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 180px;
        }
        input[type=range], select {
            width: 220px;
            margin-top: 6px;
            accent-color: #888;
            border-radius: 6px;
            border: 1px solid #333;
            background: #232526;
            color: #e0e0e0;
            padding: 4px 8px;
        }
        select {
            width: 230px;
        }
        .canvas-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background: #232526;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.25);
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            width: 100%;
            height: auto;
            max-width: 860px;
            min-height: 300px;
            border-radius: 8px;
            box-shadow: 0 1px 8px rgba(0,0,0,.25);
            background: #181a1b;
            display: block;
        }
        @media (max-width: 1000px) {
            .container { padding: 8px; }
            .controls { gap: 12px; }
            .canvas-container { padding: 4px; }
            canvas { max-width: 98vw; }
        }
        @media (max-width: 700px) {
            .controls { flex-direction: column; gap: 8px; }
            .top-bar { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1></h1>
        <div class="top-bar">
            <label class="fab-label">
                <button class="fab" id="uploadBtn" title="Upload Image" type="button">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
                <span></span>
            </label>
            <input type="file" id="upload" accept="image/*" style="display:none;">
            <label class="fab-label">
                <button class="fab" id="downloadBtn" disabled title="Download Pixel Art" type="button">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                    </svg>
                </button>
                <span></span>
            </label>
        </div>
        <div class="controls">
            <label>Brightness:
                <input type="range" id="brightness" min="-100" max="100" value="0">
            </label>
            <label>Contrast:
                <input type="range" id="contrast" min="-100" max="100" value="0">
            </label>
            <label>Hue:
                <input type="range" id="hue" min="0" max="360" value="0">
            </label>
            <label>Saturation:
                <input type="range" id="saturation" min="0" max="3" step="0.01" value="1">
            </label>
            <label>
                <input type="checkbox" id="invert"> Invert Colors
            </label>
            <label>
                <input type="checkbox" id="crtGlow"> CRT Glow
            </label>
            <label>
                <input type="checkbox" id="crtCurvature"> CRT Curvature
            </label>
            <label>Dithering Intensity:
                <input type="range" id="dither" min="0" max="1" step="0.01" value="0.3">
            </label>
            <label>Pixel Size:
                <input type="range" id="pixelSize" min="1" max="20" step="1" value="4">
            </label>
            <label>Effect Algorithm:
                <select id="algorithm">
                    <option value="none">Clean Pixelation</option>
                    <option value="simple">Simple Dither</option>
                    <option value="atkinson">Atkinson Dither</option>
                    <option value="halftone">Halftone Dots</option>
                    <option value="glitch">Glitch Effect</option>
                    <option value="crt">CRT/Scanlines</option>
                </select>
            </label>
            <label>Color Palette:
                <select id="palette">
                    <option value="original">Original Colors</option>
                    <option value="grayscale8">Grayscale 8</option>
                    <option value="grayscale16">Grayscale 16</option>
                    <option value="space16">Space 16 (Sci-Fi)</option>
                    <option value="gameboy">Game Boy Green</option>
                    <option value="posterize8">Posterize 8</option>
                    <option value="sepia">Sepia Tone</option>
                    <option value="colorhunt-ocean">Ocean Deep</option>
                    <option value="colorhunt-sunset">Sunset Vibes</option>
                    <option value="colorhunt-vintage">Vintage Film</option>
                    <option value="colorhunt-midnight">Midnight Blue</option>
                    <option value="colorhunt-techno">Cyber Techno</option>
                    <option value="cga">CGA</option>
                    <option value="ega">EGA</option>
                    <option value="commodore64">Commodore 64</option>
                    <option value="nes">NES</option>
                    <option value="gbc">Game Boy Color</option>
                    <option value="sepia2">Sepia 2</option>
                    <option value="monochrome">Monochrome</option>
                    <option value="vaporwave">Vaporwave</option>
                    <option value="pastel">Pastel</option>
                    <option value="fire">Fire</option>
                    <option value="ice">Ice</option>
                    <option value="forest">Forest</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="desert">Desert</option>
                    <option value="neon">Neon</option>
                    <option value="synthwave">80s Synthwave</option>
                    <option value="retro-sunset">Retro Sunset</option>
                    <option value="iceberg">Iceberg</option>
                    <option value="forest-moss">Forest Moss</option>
                    <option value="peachy">Peachy</option>
                    <option value="cyberlime">Cyberlime</option>
                    <option value="lavender-dream">Lavender Dream</option>
                    <option value="coffee-break">Coffee Break</option>
                    <option value="blueprint">Blueprint</option>
                    <option value="rose-gold">Rose Gold</option>
                    <option value="grape-soda">Grape Soda</option>
                    <option value="infrared">Infrared</option>
                    <option value="trichroic">Trichroic (IR/UV)</option>
                    <!-- <option value="reduced8">Reduced Original (8 colors)</option>
                    <option value="reduced16">Reduced Original (16 colors)</option>
                    <option value="reduced32">Reduced Original (32 colors)</option>
                    <option value="reduced-primaries">Reduced Major Colors</option> -->
                </select>
            </label>
            <label>Pre-Quantize Colors:
            <select id="prequant">
                <option value="none">None</option>
                <option value="reduced8">8 Colors</option>
                <option value="reduced16">16 Colors</option>
                <option value="reduced32">32 Colors</option>
                <option value="reduced64">64 Colors</option>
                <option value="reduced128">128 Colors</option>
                <option value="reduced256">256 Colors</option>
                <option value="reduced512">512 Colors</option>
                <option value="reduced-primaries">Reduced</option>
            </select>
        </label>
        </div>
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadInput = document.getElementById('upload');
        const uploadBtn = document.getElementById('uploadBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let img = new Image();

        function applyPalette(r, g, b, palette, quantizedPalette) {
            if (palette === 'grayscale8') {
                let avg = Math.round((r * 0.299 + g * 0.587 + b * 0.114));
                avg = Math.floor(avg / 32) * 32;
                return [avg, avg, avg];
            }
            if (palette === 'grayscale16') {
                let avg = Math.round((r * 0.299 + g * 0.587 + b * 0.114));
                avg = Math.floor(avg / 16) * 16;
                return [avg, avg, avg];
            }
            if (palette === 'space16') {
                let brightness = (r * 0.299 + g * 0.587 + b * 0.114);
                if (brightness < 16) return [0, 0, 0];
                else if (brightness < 32) return [16, 0, 32];
                else if (brightness < 48) return [32, 0, 64];
                else if (brightness < 64) return [64, 0, 128];
                else if (brightness < 80) return [32, 32, 96];
                else if (brightness < 96) return [64, 64, 128];
                else if (brightness < 112) return [96, 32, 160];
                else if (brightness < 128) return [128, 64, 192];
                else if (brightness < 144) return [64, 128, 255];
                else if (brightness < 160) return [128, 160, 255];
                else if (brightness < 176) return [160, 192, 255];
                else if (brightness < 192) return [192, 224, 255];
                else if (brightness < 208) return [224, 240, 255];
                else if (brightness < 224) return [240, 248, 255];
                else if (brightness < 240) return [248, 252, 255];
                else return [255, 255, 255];
            }
            if (palette === 'gameboy') {
                let avg = (r * 0.299 + g * 0.587 + b * 0.114);
                if (avg < 64) return [15, 56, 15];
                else if (avg < 128) return [48, 98, 48];
                else if (avg < 192) return [139, 172, 15];
                else return [155, 188, 15];
            }
            if (palette === 'posterize8') {
                return [Math.floor(r / 85) * 85, Math.floor(g / 85) * 85, Math.floor(b / 85) * 85];
            }
            if (palette === 'sepia') {
                let tr = Math.min(255, 0.393 * r + 0.769 * g + 0.189 * b);
                let tg = Math.min(255, 0.349 * r + 0.686 * g + 0.168 * b);
                let tb = Math.min(255, 0.272 * r + 0.534 * g + 0.131 * b);
                return [tr, tg, tb];
            }
            if (palette === 'infrared') {
                // Calculate brightness (intensity)
                let intensity = (r * 0.299 + g * 0.587 + b * 0.114) / 255;
                // Map intensity to a thermal color scale
                // Blue -> Cyan -> Green -> Yellow -> Orange -> Red -> White
                let thermalColors = [
                    [0, 0, 128],    // dark blue
                    [0, 0, 255],    // blue
                    [0, 255, 255],  // cyan
                    [0, 255, 0],    // green
                    [255, 255, 0],  // yellow
                    [255, 128, 0],  // orange
                    [255, 0, 0],    // red
                    [255, 255, 255] // white
                ];
                let idx = intensity * (thermalColors.length - 1);
                let low = Math.floor(idx);
                let high = Math.ceil(idx);
                let t = idx - low;
                let c1 = thermalColors[low];
                let c2 = thermalColors[high];
                // Linear interpolation between colors
                let outR = Math.round(c1[0] + (c2[0] - c1[0]) * t);
                let outG = Math.round(c1[1] + (c2[1] - c1[1]) * t);
                let outB = Math.round(c1[2] + (c2[2] - c1[2]) * t);
                return [outR, outG, outB];
            }
            if (palette === 'trichroic') {
                // Simulate: R=visible (gray), G=UV (yellow), B=IR (blue)
                let gray = Math.round((r + g + b) / 3);
                let uv = g; // treat green as UV for simulation
                let ir = b; // treat blue as IR for simulation
                // Map: visible=gray, IR=blue, UV=yellow
                return [
                    Math.max(gray, uv), // yellowish if UV strong
                    Math.max(gray, uv),
                    Math.max(gray, ir)  // blueish if IR strong
                ];
            }
            if (palette.startsWith('reduced')) {
                // Use the quantizedPalette passed in
                let minDist = Infinity, match = [r, g, b];
                if (quantizedPalette) {
                    for (let c of quantizedPalette) {
                        let d = (r-c[0])**2 + (g-c[1])**2 + (b-c[2])**2;
                        if (d < minDist) { minDist = d; match = c; }
                    }
                }
                return match;
            }
            // const palettes = {
            //     'colorhunt-ocean': [
            //         [8, 27, 53], [23, 42, 69], [34, 61, 104], [29, 80, 145], [0, 113, 188],
            //         [0, 163, 204], [0, 204, 255], [43, 204, 204], [87, 223, 255], [138, 236, 255],
            //         [200, 249, 255], [244, 253, 255], [255, 255, 255], [170, 196, 207], [74, 117, 146],
            //         [52, 89, 122], [30, 60, 90], [60, 120, 180], [90, 180, 210], [120, 210, 230],
            //         [180, 230, 250], [210, 240, 255], [100, 150, 200], [50, 100, 150]
            //     ],
            //     'colorhunt-sunset': [
            //         [43, 16, 61], [91, 31, 97], [138, 37, 122], [191, 45, 122], [226, 80, 93],
            //         [245, 118, 66], [255, 153, 102], [255, 190, 90], [255, 208, 120], [255, 223, 168],
            //         [255, 237, 202], [255, 245, 225], [255, 255, 255], [224, 156, 103], [201, 97, 76],
            //         [171, 51, 60], [255, 102, 102], [255, 128, 128], [255, 178, 102], [255, 204, 153],
            //         [255, 229, 180], [255, 240, 200], [255, 220, 180], [255, 200, 160]
            //     ],
            //     'colorhunt-vintage': [
            //         [61, 38, 24], [88, 63, 37], [125, 88, 73], [160, 112, 90], [186, 133, 106],
            //         [221, 193, 152], [230, 200, 170], [242, 228, 200], [249, 241, 219], [255, 255, 245],
            //         [216, 160, 112], [179, 129, 99], [136, 109, 98], [205, 192, 163], [178, 142, 110],
            //         [126, 102, 82], [200, 180, 150], [180, 160, 130], [160, 140, 110], [140, 120, 100],
            //         [120, 100, 80], [100, 80, 60], [80, 60, 40], [60, 40, 20]
            //     ],
            //     'colorhunt-midnight': [
            //         [6, 7, 20], [13, 17, 43], [25, 25, 112], [35, 36, 70], [58, 68, 135],
            //         [72, 61, 139], [75, 0, 130], [106, 90, 205], [123, 104, 238], [138, 43, 226],
            //         [169, 169, 169], [193, 200, 225], [220, 220, 220], [237, 245, 255], [255, 255, 255],
            //         [116, 146, 179], [40, 40, 80], [60, 60, 120], [80, 80, 160], [100, 100, 200],
            //         [120, 120, 240], [180, 180, 255], [210, 210, 255], [240, 240, 255]
            //     ],
            //     'colorhunt-techno': [
            //         [20, 20, 40], [0, 255, 127], [0, 191, 255], [0, 255, 255], [0, 255, 0],
            //         [75, 0, 130], [138, 43, 226], [148, 0, 211], [255, 0, 255], [255, 20, 147],
            //         [255, 69, 0], [255, 140, 0], [255, 255, 0], [255, 255, 255], [128, 0, 128],
            //         [0, 0, 0], [64, 224, 208], [127, 255, 212], [0, 128, 128], [0, 255, 128],
            //         [128, 0, 255], [255, 0, 128], [255, 128, 0], [128, 255, 0]
            //     ],
            //     'cga': [
            //         [0,0,0], [170,255,238], [255,85,255], [255,255,255]
            //     ],
            //     'ega': [
            //         [0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],
            //         [85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]
            //     ],
            //     'commodore64': [
            //         [0,0,0],[255,255,255],[136,0,0],[170,255,238],[204,68,204],[0,204,85],[0,0,170],[238,238,119],
            //         [221,136,85],[102,68,0],[255,119,119],[51,51,51],[119,119,119],[170,255,102],[0,136,255],[187,187,187]
            //     ],
            //     'nes': [
            //         [124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],
            //         [80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0]
            //     ],
            //     'gbc': [
            //         [15,56,15],[48,98,48],[139,172,15],[155,188,15],[222,248,164],[255,255,255]
            //     ],
            //     'sepia2': [
            //         [62, 39, 35],[141, 110, 99],[188, 170, 164],[239, 235, 233],[255, 255, 255]
            //     ],
            //     'monochrome': [
            //         [0,0,0],[255,255,255]
            //     ],
            //     'vaporwave': [
            //         [255, 0, 255], [0, 255, 255], [255, 255, 255], [0, 0, 0],
            //         [255, 94, 247], [0, 255, 200], [255, 204, 229], [137, 207, 240],
            //         [255, 175, 204], [255, 255, 128], [128, 0, 255], [0, 128, 255]
            //     ],
            //     'pastel': [
            //         [255, 179, 186], [255, 223, 186], [255, 255, 186], [186, 255, 201],
            //         [186, 225, 255], [202, 191, 255], [255, 201, 255], [255, 255, 255]
            //     ],
            //     'fire': [
            //         [0, 0, 0], [60, 0, 0], [120, 20, 0], [200, 40, 0], [255, 80, 0],
            //         [255, 140, 0], [255, 200, 0], [255, 255, 0], [255, 255, 128], [255, 255, 255]
            //     ],
            //     'ice': [
            //         [0, 0, 0], [0, 32, 64], [0, 64, 128], [0, 128, 255], [128, 200, 255],
            //         [200, 240, 255], [255, 255, 255], [180, 255, 255]
            //     ],
            //     'forest': [
            //         [34, 32, 52], [69, 40, 60], [102, 57, 49], [143, 86, 59], [223, 113, 38],
            //         [217, 160, 102], [238, 195, 154], [251, 242, 54], [153, 229, 80], [106, 190, 48],
            //         [55, 148, 110], [75, 105, 47], [82, 75, 36], [50, 60, 57], [63, 63, 116], [48, 96, 130]
            //     ],
            //     'cyberpunk': [
            //         [10, 10, 30], [255, 0, 110], [0, 255, 180], [255, 255, 255], [255, 255, 0],
            //         [0, 255, 255], [255, 0, 255], [0, 0, 0], [255, 80, 0], [0, 128, 255]
            //     ],
            //     'desert': [
            //         [210, 180, 140], [244, 164, 96], [222, 184, 135], [250, 214, 165], [255, 236, 179],
            //         [255, 248, 220], [205, 133, 63], [139, 69, 19], [160, 82, 45], [255, 255, 255]
            //     ],
            //     'neon': [
            //         [0, 0, 0], [57, 255, 20], [255, 20, 147], [0, 191, 255], [255, 255, 0],
            //         [255, 0, 255], [255, 69, 0], [255, 255, 255]
            //     ],
            //     'synthwave': [
            //         [20, 20, 60], [40, 0, 80], [255, 0, 110], [255, 20, 147], [255, 94, 247],
            //         [0, 255, 200], [0, 191, 255], [0, 255, 255], [255, 255, 128], [255, 255, 255],
            //         [255, 128, 0], [255, 0, 255], [128, 0, 255], [0, 128, 255], [255, 255, 0],
            //         [255, 69, 0], [255, 20, 147], [255, 0, 128], [128, 255, 255], [255, 0, 64]
            //     ],
            //     'retro-sunset': [
            //         [255, 94, 77], [255, 195, 113], [255, 255, 128], [255, 168, 168], [255, 94, 187],
            //         [255, 0, 128], [255, 128, 0], [255, 0, 0], [255, 255, 255], [0, 0, 0]
            //     ],
            //     'iceberg': [
            //         [0, 48, 73], [36, 123, 160], [112, 193, 179], [178, 219, 191], [255, 255, 255],
            //         [52, 152, 219], [133, 193, 233], [236, 240, 241], [189, 195, 199], [44, 62, 80]
            //     ],
            //     'forest-moss': [
            //         [34, 49, 63], [78, 205, 196], [34, 153, 84], [113, 201, 206], [144, 190, 109],
            //         [67, 170, 139], [77, 144, 142], [38, 70, 83], [0, 48, 73], [255, 255, 255]
            //     ],
            //     'peachy': [
            //         [255, 229, 180], [255, 204, 204], [255, 153, 153], [255, 102, 102], [255, 51, 51],
            //         [255, 87, 34], [255, 138, 101], [255, 183, 77], [255, 236, 179], [255, 255, 255]
            //     ],
            //     'cyberlime': [
            //         [0, 0, 0], [29, 185, 84], [255, 255, 255], [0, 255, 128], [0, 255, 0],
            //         [128, 255, 0], [0, 128, 0], [51, 255, 153], [204, 255, 51], [153, 255, 204]
            //     ],
            //     'lavender-dream': [
            //         [230, 230, 250], [216, 191, 216], [221, 160, 221], [186, 85, 211], [148, 0, 211],
            //         [138, 43, 226], [123, 104, 238], [106, 90, 205], [72, 61, 139], [54, 33, 89]
            //     ],
            //     'coffee-break': [
            //         [44, 34, 24], [92, 64, 51], [141, 110, 99], [188, 170, 164], [239, 235, 233],
            //         [205, 133, 63], [160, 82, 45], [210, 180, 140], [255, 248, 220], [255, 255, 255]
            //     ],
            //     'blueprint': [
            //         [10, 25, 47], [33, 97, 140], [52, 152, 219], [127, 179, 213], [174, 214, 241],
            //         [236, 240, 241], [189, 195, 199], [44, 62, 80], [21, 67, 96], [0, 0, 0]
            //     ],
            //     'rose-gold': [
            //         [183, 131, 131], [255, 192, 203], [255, 182, 193], [255, 228, 225], [255, 215, 180],
            //         [255, 218, 185], [255, 239, 213], [255, 250, 250], [255, 255, 255], [205, 133, 63]
            //     ],
            //     'grape-soda': [
            //         [54, 33, 89], [104, 58, 110], [153, 93, 153], [204, 153, 204], [255, 204, 255],
            //         [221, 160, 221], [186, 85, 211], [148, 0, 211], [230, 230, 250], [255, 255, 255]
            //     ],
            //     'reduced-primaries': [
            //         // Reds
            //         [230, 25, 75], [180, 0, 36], [255, 128, 128],
            //         // Oranges
            //         [245, 130, 48], [255, 180, 80],
            //         // Yellows
            //         [255, 255, 25], [255, 255, 153],
            //         // Greens
            //         [60, 180, 75], [180, 255, 180], [0, 128, 0],
            //         // Blues
            //         [0, 130, 200], [180, 180, 255], [0, 0, 128],
            //         // Purples
            //         [145, 30, 180], [200, 162, 200],
            //         // Browns
            //         [128, 0, 0], [80, 60, 40], [210, 180, 140],
            //         // Grays/Black/White
            //         [0, 0, 0], [100, 100, 100], [200, 200, 200], [255, 255, 255],
            //         // Cyan/Magenta
            //         [70, 240, 240], [240, 50, 230]
            //     ],
            //     'infrared': null,
            //     'trichroic': null
            // };
            const palettes = {
                'colorhunt-ocean': [
                    [8, 27, 53], [23, 42, 69], [34, 61, 104], [29, 80, 145], [0, 113, 188],
                    [0, 163, 204], [0, 204, 255], [43, 204, 204], [87, 223, 255], [138, 236, 255],
                    [200, 249, 255], [244, 253, 255], [255, 255, 255], [170, 196, 207], [74, 117, 146],
                    [52, 89, 122], [30, 60, 90], [60, 120, 180], [90, 180, 210], [120, 210, 230],
                    [180, 230, 250], [210, 240, 255], [100, 150, 200], [50, 100, 150]
                ],
                'colorhunt-sunset': [
                    [43, 16, 61], [91, 31, 97], [138, 37, 122], [191, 45, 122], [226, 80, 93],
                    [245, 118, 66], [255, 153, 102], [255, 190, 90], [255, 208, 120], [255, 223, 168],
                    [255, 237, 202], [255, 245, 225], [255, 255, 255], [224, 156, 103], [201, 97, 76],
                    [171, 51, 60], [255, 102, 102], [255, 128, 128], [255, 178, 102], [255, 204, 153],
                    [255, 229, 180], [255, 240, 200], [255, 220, 180], [255, 200, 160]
                ],
                'colorhunt-vintage': [
                    [61, 38, 24], [88, 63, 37], [125, 88, 73], [160, 112, 90], [186, 133, 106],
                    [221, 193, 152], [230, 200, 170], [242, 228, 200], [249, 241, 219], [255, 255, 245],
                    [216, 160, 112], [179, 129, 99], [136, 109, 98], [205, 192, 163], [178, 142, 110],
                    [126, 102, 82], [200, 180, 150], [180, 160, 130], [160, 140, 110], [140, 120, 100],
                    [120, 100, 80], [100, 80, 60], [80, 60, 40], [60, 40, 20]
                ],
                'colorhunt-midnight': [
                    [6, 7, 20], [13, 17, 43], [25, 25, 112], [35, 36, 70], [58, 68, 135],
                    [72, 61, 139], [75, 0, 130], [106, 90, 205], [123, 104, 238], [138, 43, 226],
                    [169, 169, 169], [193, 200, 225], [220, 220, 220], [237, 245, 255], [255, 255, 255],
                    [116, 146, 179], [40, 40, 80], [60, 60, 120], [80, 80, 160], [100, 100, 200],
                    [120, 120, 240], [180, 180, 255], [210, 210, 255], [240, 240, 255]
                ],
                'colorhunt-techno': [
                    [20, 20, 40], [0, 255, 127], [0, 191, 255], [0, 255, 255], [0, 255, 0],
                    [75, 0, 130], [138, 43, 226], [148, 0, 211], [255, 0, 255], [255, 20, 147],
                    [255, 69, 0], [255, 140, 0], [255, 255, 0], [255, 255, 255], [128, 0, 128],
                    [0, 0, 0], [64, 224, 208], [127, 255, 212], [0, 128, 128], [0, 255, 128],
                    [128, 0, 255], [255, 0, 128], [255, 128, 0], [128, 255, 0]
                ],
                'cga': [
                    [0,0,0], [170,255,238], [255,85,255], [255,255,255],
                    [85,255,85], [255,255,85], [255,85,85], [85,85,255],
                    [85,255,255], [255,85,170], [170,85,255], [255,170,85],
                    [85,170,255], [170,255,85], [255,170,170], [170,170,170]
                ],
                'ega': [
                    [0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],
                    [85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]
                ],
                'commodore64': [
                    [0,0,0],[255,255,255],[136,0,0],[170,255,238],[204,68,204],[0,204,85],[0,0,170],[238,238,119],
                    [221,136,85],[102,68,0],[255,119,119],[51,51,51],[119,119,119],[170,255,102],[0,136,255],[187,187,187]
                ],
                'nes': [
                    [124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],
                    [80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0]
                ],
                'gbc': [
                    [15,56,15], [48,98,48], [139,172,15], [155,188,15], [222,248,164], [255,255,255],
                    [106,190,48], [55,148,110], [75,105,47], [82,75,36], [50,60,57], [63,63,116],
                    [48,96,130], [120,184,232], [184,248,216], [248,248,248]
                ],
                'sepia2': [
                    [62, 39, 35], [141, 110, 99], [188, 170, 164], [239, 235, 233], [255, 255, 255],
                    [112, 66, 20], [133, 94, 66], [181, 101, 29], [205, 133, 63], [210, 180, 140],
                    [222, 184, 135], [244, 164, 96], [255, 248, 220], [255, 235, 205], [245, 222, 179], [255, 228, 196]
                ],
                'monochrome': [
                    [0,0,0], [32,32,32], [64,64,64], [96,96,96],
                    [128,128,128], [160,160,160], [192,192,192], [224,224,224],
                    [255,255,255], [48,48,48], [80,80,80], [112,112,112],
                    [144,144,144], [176,176,176], [208,208,208], [240,240,240]
                ],
                'vaporwave': [
                    [255, 0, 255], [0, 255, 255], [255, 255, 255], [0, 0, 0],
                    [255, 94, 247], [0, 255, 200], [255, 204, 229], [137, 207, 240],
                    [255, 175, 204], [255, 255, 128], [128, 0, 255], [0, 128, 255],
                    [255, 182, 193], [186, 85, 211], [148, 0, 211], [255, 105, 180]
                ],
                'pastel': [
                    [255, 179, 186], [255, 223, 186], [255, 255, 186], [186, 255, 201],
                    [186, 225, 255], [202, 191, 255], [255, 201, 255], [255, 255, 255],
                    [255, 204, 229], [255, 239, 213], [255, 250, 205], [221, 160, 221],
                    [255, 222, 173], [240, 255, 240], [255, 228, 225], [230, 230, 250]
                ],
                'fire': [
                    [0, 0, 0], [60, 0, 0], [120, 20, 0], [200, 40, 0], [255, 80, 0],
                    [255, 140, 0], [255, 200, 0], [255, 255, 0], [255, 255, 128], [255, 255, 255],
                    [255, 180, 0], [255, 220, 0], [255, 240, 128], [255, 200, 80], [255, 160, 40], [200, 100, 0]
                ],
                'ice': [
                    [0, 0, 0], [0, 32, 64], [0, 64, 128], [0, 128, 255], [128, 200, 255],
                    [200, 240, 255], [255, 255, 255], [180, 255, 255],
                    [220, 240, 255], [180, 220, 240], [140, 200, 220], [100, 180, 200],
                    [60, 160, 180], [20, 140, 160], [0, 120, 140], [0, 100, 120]
                ],
                'forest': [
                    [34, 32, 52], [69, 40, 60], [102, 57, 49], [143, 86, 59], [223, 113, 38],
                    [217, 160, 102], [238, 195, 154], [251, 242, 54], [153, 229, 80], [106, 190, 48],
                    [55, 148, 110], [75, 105, 47], [82, 75, 36], [50, 60, 57], [63, 63, 116], [48, 96, 130]
                ],
                'cyberpunk': [
                    [10, 10, 30], [255, 0, 110], [0, 255, 180], [255, 255, 255], [255, 255, 0],
                    [0, 255, 255], [255, 0, 255], [0, 0, 0], [255, 80, 0], [0, 128, 255],
                    [255, 20, 147], [255, 69, 0], [128, 0, 255], [0, 191, 255], [255, 128, 0], [255, 0, 128]
                ],
                'desert': [
                    [210, 180, 140], [244, 164, 96], [222, 184, 135], [250, 214, 165], [255, 236, 179],
                    [255, 248, 220], [205, 133, 63], [139, 69, 19], [160, 82, 45], [255, 255, 255],
                    [255, 228, 181], [238, 232, 170], [240, 230, 140], [255, 222, 173], [245, 222, 179], [255, 239, 213]
                ],
                'neon': [
                    [0, 0, 0], [57, 255, 20], [255, 20, 147], [0, 191, 255], [255, 255, 0],
                    [255, 0, 255], [255, 69, 0], [255, 255, 255],
                    [0, 255, 255], [0, 255, 128], [128, 0, 255], [255, 128, 0], [128, 255, 0], [255, 0, 128], [0, 128, 255], [128, 255, 255]
                ],
                'synthwave': [
                    [20, 20, 60], [40, 0, 80], [255, 0, 110], [255, 20, 147], [255, 94, 247],
                    [0, 255, 200], [0, 191, 255], [0, 255, 255], [255, 255, 128], [255, 255, 255],
                    [255, 128, 0], [255, 0, 255], [128, 0, 255], [0, 128, 255], [255, 255, 0],
                    [255, 69, 0], [255, 20, 147], [255, 0, 128], [128, 255, 255], [255, 0, 64]
                ],
                'retro-sunset': [
                    [255, 94, 77], [255, 195, 113], [255, 255, 128], [255, 168, 168], [255, 94, 187],
                    [255, 0, 128], [255, 128, 0], [255, 0, 0], [255, 255, 255], [0, 0, 0],
                    [255, 153, 102], [255, 190, 90], [255, 208, 120], [255, 223, 168], [255, 237, 202], [255, 245, 225]
                ],
                'iceberg': [
                    [0, 48, 73], [36, 123, 160], [112, 193, 179], [178, 219, 191], [255, 255, 255],
                    [52, 152, 219], [133, 193, 233], [236, 240, 241], [189, 195, 199], [44, 62, 80],
                    [100, 180, 200], [140, 200, 220], [180, 220, 240], [220, 240, 255], [180, 255, 255], [200, 240, 255]
                ],
                'forest-moss': [
                    [34, 49, 63], [78, 205, 196], [34, 153, 84], [113, 201, 206], [144, 190, 109],
                    [67, 170, 139], [77, 144, 142], [38, 70, 83], [0, 48, 73], [255, 255, 255],
                    [120, 180, 120], [80, 120, 80], [60, 100, 60], [100, 140, 100], [180, 220, 180], [200, 240, 200]
                ],
                'peachy': [
                    [255, 229, 180], [255, 204, 204], [255, 153, 153], [255, 102, 102], [255, 51, 51],
                    [255, 87, 34], [255, 138, 101], [255, 183, 77], [255, 236, 179], [255, 255, 255],
                    [255, 218, 185], [255, 239, 213], [255, 250, 250], [255, 215, 180], [255, 182, 193], [255, 192, 203]
                ],
                'cyberlime': [
                    [0, 0, 0], [29, 185, 84], [255, 255, 255], [0, 255, 128], [0, 255, 0],
                    [128, 255, 0], [0, 128, 0], [51, 255, 153], [204, 255, 51], [153, 255, 204],
                    [180, 255, 180], [128, 255, 128], [204, 255, 204], [51, 204, 51], [102, 255, 102], [0, 204, 0]
                ],
                'lavender-dream': [
                    [230, 230, 250], [216, 191, 216], [221, 160, 221], [186, 85, 211], [148, 0, 211],
                    [138, 43, 226], [123, 104, 238], [106, 90, 205], [72, 61, 139], [54, 33, 89],
                    [200, 162, 200], [180, 140, 180], [160, 120, 160], [140, 100, 140], [120, 80, 120], [100, 60, 100]
                ],
                'coffee-break': [
                    [44, 34, 24], [92, 64, 51], [141, 110, 99], [188, 170, 164], [239, 235, 233],
                    [205, 133, 63], [160, 82, 45], [210, 180, 140], [255, 248, 220], [255, 255, 255],
                    [120, 80, 40], [100, 60, 20], [80, 40, 0], [60, 20, 0], [40, 0, 0], [20, 0, 0]
                ],
                'blueprint': [
                    [10, 25, 47], [33, 97, 140], [52, 152, 219], [127, 179, 213], [174, 214, 241],
                    [236, 240, 241], [189, 195, 199], [44, 62, 80], [21, 67, 96], [0, 0, 0],
                    [60, 120, 180], [90, 180, 210], [120, 210, 230], [180, 230, 250], [210, 240, 255], [100, 150, 200]
                ],
                'rose-gold': [
                    [183, 131, 131], [255, 192, 203], [255, 182, 193], [255, 228, 225], [255, 215, 180],
                    [255, 218, 185], [255, 239, 213], [255, 250, 250], [255, 255, 255], [205, 133, 63],
                    [255, 228, 196], [255, 222, 173], [245, 222, 179], [255, 239, 213], [255, 248, 220], [255, 235, 205]
                ],
                'grape-soda': [
                    [54, 33, 89], [104, 58, 110], [153, 93, 153], [204, 153, 204], [255, 204, 255],
                    [221, 160, 221], [186, 85, 211], [148, 0, 211], [230, 230, 250], [255, 255, 255],
                    [200, 162, 200], [180, 140, 180], [160, 120, 160], [140, 100, 140], [120, 80, 120], [100, 60, 100]
                ],
                'reduced-primaries': [
                    // Reds
                    [230, 25, 75], [180, 0, 36], [255, 128, 128],
                    // Oranges
                    [245, 130, 48], [255, 180, 80],
                    // Yellows
                    [255, 255, 25], [255, 255, 153],
                    // Greens
                    [60, 180, 75], [180, 255, 180], [0, 128, 0],
                    // Blues
                    [0, 130, 200], [180, 180, 255], [0, 0, 128],
                    // Purples
                    [145, 30, 180], [200, 162, 200],
                    // Browns
                    [128, 0, 0], [80, 60, 40], [210, 180, 140],
                    // Grays/Black/White
                    [0, 0, 0], [100, 100, 100], [200, 200, 200], [255, 255, 255],
                    // Cyan/Magenta
                    [70, 240, 240], [240, 50, 230]
                ],
                'infrared': null,
                'trichroic': null
            };
            if (palettes[palette]) {
                const pal = palettes[palette];
                let minDist = Infinity;
                let match = [r, g, b];
                for (let i = 0; i < pal.length; i++) {
                    const [pr, pg, pb] = pal[i];
                    const dist = Math.sqrt((r - pr) ** 2 + (g - pg) ** 2 + (b - pb) ** 2);
                    if (dist < minDist) {
                        minDist = dist;
                        match = pal[i];
                    }
                }
                return match;
            }
            return [r, g, b];
        }

        function atkinsonDither(imageData, width, height, palette) {
            const data = imageData.data;
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let i = (y * width + x) * 4;
                    let oldR = data[i];
                    let oldG = data[i + 1];
                    let oldB = data[i + 2];
                    let [newR, newG, newB] = applyPalette(oldR, oldG, oldB, palette);
                    let errorR = oldR - newR;
                    let errorG = oldG - newG;
                    let errorB = oldB - newB;
                    data[i] = newR;
                    data[i + 1] = newG;
                    data[i + 2] = newB;
                    const distribute = [
                        [1, 0, 1/8], [2, 0, 1/8],
                        [-1, 1, 1/8], [0, 1, 1/8], [1, 1, 1/8],
                        [0, 2, 1/8]
                    ];
                    for (let [dx, dy, factor] of distribute) {
                        let nx = x + dx;
                        let ny = y + dy;
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            let ni = (ny * width + nx) * 4;
                            data[ni] = Math.max(0, Math.min(255, data[ni] + errorR * factor));
                            data[ni + 1] = Math.max(0, Math.min(255, data[ni + 1] + errorG * factor));
                            data[ni + 2] = Math.max(0, Math.min(255, data[ni + 2] + errorB * factor));
                        }
                    }
                }
            }
            return imageData;
        }

        function resizeCanvasToFit() {
            if (!img.src) return;
            const container = document.querySelector('.canvas-container');
            let maxW = container.clientWidth - 8;
            let maxH = window.innerHeight * 0.8;
            let ratio = Math.min(maxW / img.width, maxH / img.height, 1.2);
            canvas.width = img.width;
            canvas.height = img.height;
            canvas.style.width = (img.width * ratio) + 'px';
            canvas.style.height = (img.height * ratio) + 'px';
        }

        function drawPixelArt() {
            if (!img.src) return;
            resizeCanvasToFit();
            const dither = parseFloat(document.getElementById('dither').value);
            const pixelSize = parseInt(document.getElementById('pixelSize').value);
            const algorithm = document.getElementById('algorithm').value;
            const palette = document.getElementById('palette').value;
            const prequant = document.getElementById('prequant').value;
            ctx.drawImage(img, 0, 0);
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            // === Color & Tone Adjustments ===
            const brightness = parseInt(document.getElementById('brightness').value);
            const contrast = parseInt(document.getElementById('contrast').value);
            const hue = parseInt(document.getElementById('hue').value);
            const saturation = parseFloat(document.getElementById('saturation').value);
            const invert = document.getElementById('invert').checked;

            for (let i = 0; i < data.length; i += 4) {
                // Brightness
                data[i] += brightness;
                data[i+1] += brightness;
                data[i+2] += brightness;
                // Contrast
                data[i] = ((data[i] - 128) * (contrast/100 + 1)) + 128;
                data[i+1] = ((data[i+1] - 128) * (contrast/100 + 1)) + 128;
                data[i+2] = ((data[i+2] - 128) * (contrast/100 + 1)) + 128;
                // Invert
                if (invert) {
                    data[i] = 255 - data[i];
                    data[i+1] = 255 - data[i+1];
                    data[i+2] = 255 - data[i+2];
                }
                // Clamp
                data[i] = Math.max(0, Math.min(255, data[i]));
                data[i+1] = Math.max(0, Math.min(255, data[i+1]));
                data[i+2] = Math.max(0, Math.min(255, data[i+2]));
            }
            // Proper HSL conversion for hue/saturation
            if (hue !== 0 || saturation !== 1) {
                for (let i = 0; i < data.length; i += 4) {
                    // Convert RGB to [0,1]
                    let r = data[i] / 255, g = data[i+1] / 255, b = data[i+2] / 255;
                    let max = Math.max(r, g, b), min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;

                    if (max === min) {
                        h = s = 0;
                    } else {
                        let d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                        switch (max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }
                        h /= 6;
                    }

                    // Adjust hue and saturation
                    h = (h * 360 + hue) % 360;
                    if (h < 0) h += 360;
                    h /= 360;
                    s = Math.max(0, Math.min(1, s * saturation));

                    // Convert HSL back to RGB
                    let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    let p = 2 * l - q;
                    function hue2rgb(p, q, t) {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    }
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);

                    data[i] = Math.max(0, Math.min(255, Math.round(r * 255)));
                    data[i+1] = Math.max(0, Math.min(255, Math.round(g * 255)));
                    data[i+2] = Math.max(0, Math.min(255, Math.round(b * 255)));
                }
            }
            ctx.putImageData(imageData, 0, 0);
            if (algorithm === 'atkinson') {
                imageData = atkinsonDither(imageData, canvas.width, canvas.height, palette);
                ctx.putImageData(imageData, 0, 0);
                downloadBtn.disabled = false;
                return;
            }

            // === Pre-Quantize Colors if selected ===
            let preQuantPalette = null;
            if (prequant !== "none") {
                if (prequant === "reduced-primaries") {
                    preQuantPalette = palettes["reduced-primaries"];
                } else if (prequant.startsWith('reduced')) {
                    // Use your k-means quantization code here, just like before
                    let numColors = parseInt(prequant.replace('reduced', ''), 10) || 8;
                    let allColors = [];
                    for (let i = 0; i < data.length; i += 4) {
                        allColors.push([data[i], data[i+1], data[i+2]]);
                    }
                    let clusters = [];
                    for (let i = 0; i < numColors; i++) {
                        clusters.push(allColors[Math.floor(Math.random() * allColors.length)]);
                    }
                    for (let iter = 0; iter < 2; iter++) {
                        let buckets = Array.from({length: numColors}, () => []);
                        for (let c of allColors) {
                            let minDist = Infinity, idx = 0;
                            for (let i = 0; i < clusters.length; i++) {
                                let d = (c[0]-clusters[i][0])**2 + (c[1]-clusters[i][1])**2 + (c[2]-clusters[i][2])**2;
                                if (d < minDist) { minDist = d; idx = i; }
                            }
                            buckets[idx].push(c);
                        }
                        for (let i = 0; i < clusters.length; i++) {
                            if (buckets[i].length) {
                                let r = 0, g = 0, b = 0;
                                for (let c of buckets[i]) { r += c[0]; g += c[1]; b += c[2]; }
                                clusters[i] = [
                                    Math.round(r / buckets[i].length),
                                    Math.round(g / buckets[i].length),
                                    Math.round(b / buckets[i].length)
                                ];
                            }
                        }
                    }
                    preQuantPalette = clusters;
                }
                // Apply pre-quantization to image data
                for (let i = 0; i < data.length; i += 4) {
                    let [r, g, b] = [data[i], data[i+1], data[i+2]];
                    let minDist = Infinity, match = [r, g, b];
                    for (let c of preQuantPalette) {
                        let d = (r-c[0])**2 + (g-c[1])**2 + (b-c[2])**2;
                        if (d < minDist) { minDist = d; match = c; }
                    }
                    data[i] = match[0];
                    data[i+1] = match[1];
                    data[i+2] = match[2];
                }
            }
            // Quantized palette for reduced modes
            let quantizedPalette = null;
            if (palette.startsWith('reduced')) {
                let numColors = parseInt(palette.replace('reduced', ''), 10) || 8;
                let allColors = [];
                for (let i = 0; i < data.length; i += 4) {
                    allColors.push([data[i], data[i+1], data[i+2]]);
                }
                let clusters = [];
                for (let i = 0; i < numColors; i++) {
                    clusters.push(allColors[Math.floor(Math.random() * allColors.length)]);
                }
                for (let iter = 0; iter < 2; iter++) {
                    let buckets = Array.from({length: numColors}, () => []);
                    for (let c of allColors) {
                        let minDist = Infinity, idx = 0;
                        for (let i = 0; i < clusters.length; i++) {
                            let d = (c[0]-clusters[i][0])**2 + (c[1]-clusters[i][1])**2 + (c[2]-clusters[i][2])**2;
                            if (d < minDist) { minDist = d; idx = i; }
                        }
                        buckets[idx].push(c);
                    }
                    for (let i = 0; i < clusters.length; i++) {
                        if (buckets[i].length) {
                            let r = 0, g = 0, b = 0;
                            for (let c of buckets[i]) { r += c[0]; g += c[1]; b += c[2]; }
                            clusters[i] = [
                                Math.round(r / buckets[i].length),
                                Math.round(g / buckets[i].length),
                                Math.round(b / buckets[i].length)
                            ];
                        }
                    }
                }
                quantizedPalette = clusters;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < canvas.height; y += pixelSize) {
                for (let x = 0; x < canvas.width; x += pixelSize) {
                    let r = 0, g = 0, b = 0, count = 0;
                    for (let py = y; py < Math.min(y + pixelSize, canvas.height); py++) {
                        for (let px = x; px < Math.min(x + pixelSize, canvas.width); px++) {
                            let index = (px + py * canvas.width) * 4;
                            r += data[index];
                            g += data[index + 1];
                            b += data[index + 2];
                            count++;
                        }
                    }
                    r = Math.round(r / count);
                    g = Math.round(g / count);
                    b = Math.round(b / count);
                    [r, g, b] = applyPalette(r, g, b, palette, quantizedPalette);
                    if (algorithm === 'glitch') {
                        if (Math.random() < dither * 0.03) {
                            let shift = (Math.random() - 0.5) * 30;
                            r = Math.max(0, Math.min(255, r + shift));
                            g = Math.max(0, Math.min(255, g + shift));
                            b = Math.max(0, Math.min(255, b + shift));
                        }
                    }
                    if (algorithm === 'simple' && Math.random() < dither) {
                        let noise = (Math.random() - 0.5) * 64;
                        r = Math.max(0, Math.min(255, r + noise));
                        g = Math.max(0, Math.min(255, g + noise));
                        b = Math.max(0, Math.min(255, b + noise));
                    }
                    ctx.fillStyle = `rgb(${Math.floor(r)},${Math.floor(g)},${Math.floor(b)})`;
                    ctx.fillRect(x, y, pixelSize, pixelSize);
                    if (algorithm === 'halftone') {
                        ctx.save();
                        ctx.beginPath();
                        ctx.arc(x + pixelSize / 2, y + pixelSize / 2, pixelSize / 2 * dither, 0, 2 * Math.PI);
                        ctx.clip();
                        ctx.clearRect(x, y, pixelSize, pixelSize);
                        ctx.restore();
                    }
                }
            }
            // === CRT/Scanline/Glow/Curvature Overlay (run ONCE after pixel loop) ===
            if (algorithm === 'crt') {
                // Scanlines
                let scanlineThickness = 2;
                let scanlineAlpha = 0.18;
                for (let y = 0; y < canvas.height; y += scanlineThickness * 2) {
                    ctx.save();
                    ctx.globalAlpha = scanlineAlpha;
                    ctx.fillStyle = "#000";
                    ctx.fillRect(0, y, canvas.width, scanlineThickness);
                    ctx.restore();
                }
                // Glow
                if (document.getElementById('crtGlow').checked) {
                    ctx.save();
                    ctx.globalAlpha = 0.5;
                    ctx.filter = "blur(6px)";
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = "none";
                    ctx.restore();
                }
                // Curvature
                if (document.getElementById('crtCurvature').checked) {
                    let temp = document.createElement('canvas');
                    temp.width = canvas.width;
                    temp.height = canvas.height;
                    temp.getContext('2d').drawImage(canvas, 0, 0);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Barrel distortion: draw in strips, scaling each strip
                    let strips = 120;
                    for (let i = 0; i < strips; i++) {
                        let sy = Math.floor(i * canvas.height / strips);
                        let sh = Math.ceil(canvas.height / strips);
                        let curve = Math.pow((i / (strips - 1) - 0.5) * 2, 2);
                        let scale = 1 - 0.12 * curve;
                        let dx = (canvas.width - canvas.width * scale) / 2;
                        ctx.drawImage(
                            temp,
                            0, sy, temp.width, sh,
                            dx, sy, canvas.width * scale, sh
                        );
                    }
                }
            }
            downloadBtn.disabled = false;
        }

        uploadBtn.addEventListener('click', () => uploadInput.click());
        uploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    img.src = evt.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
        downloadBtn.addEventListener('click', () => {
            if (downloadBtn.disabled) return;
            const link = document.createElement('a');
            link.download = 'pixel-art.png';
            link.href = canvas.toDataURL();
            link.click();
        });
        img.onload = function() {
            drawPixelArt();
            downloadBtn.disabled = false;
        };
        let updateTimeout;
        function debouncedUpdate() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(drawPixelArt, 100);
        }
        // ['dither', 'pixelSize', 'algorithm', 'palette', 'brightness', 'contrast', 'hue', 'saturation', 'invert', 'crtGlow', 'crtCurvature'].forEach(id => {
        //     document.getElementById(id).addEventListener('input', debouncedUpdate);
        //     document.getElementById(id).addEventListener('change', drawPixelArt);
        // });
        ['dither', 'pixelSize', 'algorithm', 'palette', 'prequant', 'brightness', 'contrast', 'hue', 'saturation', 'invert', 'crtGlow', 'crtCurvature'].forEach(id => {
            document.getElementById(id).addEventListener('input', debouncedUpdate);
            document.getElementById(id).addEventListener('change', drawPixelArt);
        });
        window.addEventListener('resize', drawPixelArt);

        // Initially disable download
        downloadBtn.disabled = true;
    });
    </script>
</body>
</html>
